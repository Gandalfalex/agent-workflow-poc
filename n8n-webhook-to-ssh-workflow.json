{
  "name": "Webhook to SSH Skill Execution",
  "description": "Universal workflow that receives raw webhook data, normalizes it, and executes skills via SSH on remote server",
  "active": true,
  "nodes": [
    {
      "parameters": {},
      "id": "webhook_trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "webhook-skill-execution"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "rawPayload",
              "value": "={{ $json }}"
            },
            {
              "name": "eventType",
              "value": "={{ $json.event_type || $json.type || 'unknown' }}"
            },
            {
              "name": "ticketId",
              "value": "={{ $json.ticket_id || $json.ticketId || $json.id || '' }}"
            },
            {
              "name": "action",
              "value": "={{ $json.action || $json.command || '' }}"
            },
            {
              "name": "data",
              "value": "={{ $json.data || {} }}"
            },
            {
              "name": "timestamp",
              "value": "={{ Date.now() }}"
            }
          ]
        }
      },
      "id": "extract_webhook_data",
      "name": "Extract Webhook Data",
      "type": "n8n-nodes-base.assignV2",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "value1": "={{ $json.eventType }}",
              "operation": "equals",
              "value2": "feature_implementation"
            }
          ]
        }
      },
      "id": "check_event_type",
      "name": "Check Event Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "skillCommand",
              "value": "={{ 'implement ' + $json.ticketId }}"
            },
            {
              "name": "skillName",
              "value": "implementing-features"
            },
            {
              "name": "workspaceRoot",
              "value": "={{ $json.data.workspace_root || '/workspaces' }}"
            },
            {
              "name": "repoPath",
              "value": "={{ $json.data.repo_path || '/repo' }}"
            }
          ]
        }
      },
      "id": "normalize_feature_implementation",
      "name": "Normalize: Feature Implementation",
      "type": "n8n-nodes-base.assignV2",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "skillCommand",
              "value": "={{ 'get ticket ' + $json.ticketId }}"
            },
            {
              "name": "skillName",
              "value": "managing-tickets"
            }
          ]
        }
      },
      "id": "normalize_ticket_query",
      "name": "Normalize: Ticket Query",
      "type": "n8n-nodes-base.assignV2",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "skillCommand",
              "value": "={{ $json.action || 'unknown' }}"
            },
            {
              "name": "skillName",
              "value": "custom"
            }
          ]
        }
      },
      "id": "normalize_fallback",
      "name": "Normalize: Fallback",
      "type": "n8n-nodes-base.assignV2",
      "typeVersion": 1,
      "position": [850, 600]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://ticketing-api:8080/webhooks/events",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event_type",
              "value": "={{ $json.eventType }}"
            },
            {
              "name": "timestamp",
              "value": "={{ $json.timestamp }}"
            },
            {
              "name": "status",
              "value": "received"
            }
          ]
        }
      },
      "id": "log_webhook_received",
      "name": "Log Webhook Received",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [450, 500]
    },
    {
      "parameters": {
        "command": "={{ 'cd /home/user/codex-agent && WORKSPACE_ROOT=' + $json.workspaceRoot + ' REPO_PATH=' + $json.repoPath + ' bash scripts/skill-cli.sh \"' + $json.skillCommand + '\"' }}",
        "authentication": "credentials",
        "credentials": "ssh_credentials"
      },
      "id": "execute_ssh_skill",
      "name": "Execute SSH Skill",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "name": "skillOutput",
              "value": "={{ $json }}"
            },
            {
              "name": "executionTime",
              "value": "={{ Date.now() - $node['extract_webhook_data'].json.timestamp }}"
            },
            {
              "name": "success",
              "value": "={{ $json.stdout && !$json.stderr }}"
            }
          ]
        }
      },
      "id": "process_ssh_output",
      "name": "Process SSH Output",
      "type": "n8n-nodes-base.assignV2",
      "typeVersion": 1,
      "position": [1250, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://ticketing-api:8080/webhooks/events",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event_type",
              "value": "={{ $json.eventType }}"
            },
            {
              "name": "status",
              "value": "success"
            },
            {
              "name": "execution_time_ms",
              "value": "={{ $json.executionTime }}"
            },
            {
              "name": "output",
              "value": "={{ $json.skillOutput }}"
            }
          ]
        }
      },
      "id": "log_execution_success",
      "name": "Log Execution Success",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://ticketing-api:8080/webhooks/events",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "event_type",
              "value": "={{ $json.eventType }}"
            },
            {
              "name": "status",
              "value": "error"
            },
            {
              "name": "error",
              "value": "={{ $json.error || 'SSH execution failed' }}"
            }
          ]
        }
      },
      "id": "log_execution_error",
      "name": "Log Execution Error",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1450, 400]
    }
  ],
  "connections": {
    "webhook_trigger": {
      "main": [
        [
          {
            "node": "extract_webhook_data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "extract_webhook_data": {
      "main": [
        [
          {
            "node": "log_webhook_received",
            "type": "main",
            "index": 0
          },
          {
            "node": "check_event_type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "log_webhook_received": {
      "main": [
        [
          {
            "node": "check_event_type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check_event_type": {
      "main": [
        [
          {
            "node": "normalize_feature_implementation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "normalize_ticket_query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "normalize_feature_implementation": {
      "main": [
        [
          {
            "node": "execute_ssh_skill",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "normalize_ticket_query": {
      "main": [
        [
          {
            "node": "execute_ssh_skill",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "normalize_fallback": {
      "main": [
        [
          {
            "node": "execute_ssh_skill",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "execute_ssh_skill": {
      "main": [
        [
          {
            "node": "process_ssh_output",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "log_execution_error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "process_ssh_output": {
      "main": [
        [
          {
            "node": "log_execution_success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
