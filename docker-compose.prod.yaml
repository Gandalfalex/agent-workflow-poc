version: "3.9"

# Production setup with Shadowing proxy for traffic mirroring
# The shadowing proxy acts as the main reverse proxy that can:
# 1. Route traffic to production services (primary)
# 2. Mirror traffic to new workspace deployments (shadow)
# 3. Compare responses and help with safe deployments
#
# Services accessible through:
# - http://localhost/ - Shadowing proxy (port 80)
# - http://localhost:8081 - Shadowing admin/UI
# - Path-based routing to ticketing and n8n

services:
  # Shadowing reverse proxy - main entry point with traffic mirroring
  shadowing:
    build:
      context: ../shadowing
      dockerfile: Dockerfile
    ports:
      - "80:8080"      # Main proxy port (HTTP)
      - "8081:8081"    # Admin/UI port
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      SHADOWING_STORE_DSN: postgres://shadowing:shadowing@shadowing-db:5432/shadowing?sslmode=disable
      SHADOWING_DOCKER_NETWORK: prod-network
    command:
      - "-listen"
      - ":8080"
      - "-admin-listen"
      - ":8081"
      - "-ui-dir"
      - "/app/ui"
      - "-store-dsn"
      - "postgres://shadowing:shadowing@shadowing-db:5432/shadowing?sslmode=disable"
      - "-docker-network"
      - "prod-network"
    depends_on:
      - shadowing-db
      - keycloak
      - ticketing-api-prod
      - n8n
    networks:
      - prod-network
    labels:
      # Enable Docker-based service discovery
      - "shadowing.enable=true"
    restart: unless-stopped

  # Shadowing database - stores comparison results and routing config
  shadowing-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: shadowing
      POSTGRES_PASSWORD: shadowing
      POSTGRES_DB: shadowing
    volumes:
      - shadowing-prod-data:/var/lib/postgresql/data
    networks:
      - prod-network
    restart: unless-stopped

  # Keycloak - Authentication for both ticketing and n8n
  keycloak:
    image: quay.io/keycloak/keycloak:26.1.1
    command: ["start-dev", "--import-realm"]
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL_HOST: keycloak-postgres
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
    volumes:
      - ./ticketing-system/keycloak/realm.json:/opt/keycloak/data/import/realm.json:ro
    networks:
      - prod-network
    depends_on:
      - keycloak-postgres
    labels:
      # Route /auth/* to Keycloak
      - "traefik.http.routers.keycloak.rule=PathPrefix(`/auth`) || PathPrefix(`/realms`)"
      - "traefik.http.services.keycloak.loadbalancer.server.port=8080"
    restart: unless-stopped

  keycloak-postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
      POSTGRES_DB: keycloak
    volumes:
      - keycloak-prod-data:/var/lib/postgresql/data
    networks:
      - prod-network
    restart: unless-stopped

  # Production Ticketing System (Primary)
  ticketing-api-prod:
    build:
      context: ./ticketing-system
      dockerfile: backend/Dockerfile
    environment:
      PORT: "8080"
      DATABASE_URL: postgres://ticketing:ticketing@ticketing-postgres-prod:5432/ticketing?sslmode=disable
      KEYCLOAK_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: ticketing
      KEYCLOAK_CLIENT_ID: myclient
      KEYCLOAK_ADMIN_USER: AdminUser
      KEYCLOAK_ADMIN_PASSWORD: admin123
      COOKIE_SECURE: "false"
      CORS_ALLOWED_ORIGINS: "*"
    depends_on:
      - ticketing-postgres-prod
      - keycloak
    networks:
      - prod-network
    labels:
      # Service discovery for shadowing proxy
      - "traefik.http.routers.ticketing.rule=PathPrefix(`/api/ticketing`) || PathPrefix(`/health`) || PathPrefix(`/users`) || PathPrefix(`/projects`) || PathPrefix(`/tickets`)"
      - "traefik.http.services.ticketing.loadbalancer.server.port=8080"
    restart: unless-stopped

  ticketing-postgres-prod:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: ticketing
      POSTGRES_PASSWORD: ticketing
      POSTGRES_DB: ticketing
    volumes:
      - ticketing-prod-data:/var/lib/postgresql/data
    networks:
      - prod-network
    restart: unless-stopped

  # n8n Workflow Automation (Primary)
  n8n:
    image: n8nio/n8n:latest
    environment:
      - N8N_HOST=0.0.0.0
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_PATH=/n8n/
      - WEBHOOK_URL=http://localhost/n8n/
      - GENERIC_TIMEZONE=Europe/Berlin
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=n8n-postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD=n8n
    volumes:
      - n8n-prod-data:/home/node/.n8n
    depends_on:
      - n8n-postgres
    networks:
      - prod-network
    labels:
      # Service discovery for shadowing proxy
      - "traefik.http.routers.n8n.rule=PathPrefix(`/n8n`) || PathPrefix(`/webhook`)"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    restart: unless-stopped

  n8n-postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: n8n
      POSTGRES_DB: n8n
    volumes:
      - n8n-prod-postgres-data:/var/lib/postgresql/data
    networks:
      - prod-network
    restart: unless-stopped

  # ============================================
  # WORKSPACE/SHADOW DEPLOYMENTS
  # These are deployed from worktrees (feature branches)
  # and can be shadowed/compared against production
  # ============================================

  # Example: Ticketing API from workspace/branch
  # This would be built from a git worktree (e.g., feature/new-dashboard)
  # Uncomment and configure to test a new version alongside production
  #
  # ticketing-api-shadow:
  #   build:
  #     context: ./worktrees/feature-name/ticketing-system
  #     dockerfile: backend/Dockerfile
  #   environment:
  #     PORT: "8080"
  #     DATABASE_URL: postgres://ticketing:ticketing@ticketing-postgres-shadow:5432/ticketing?sslmode=disable
  #     KEYCLOAK_BASE_URL: http://keycloak:8080
  #     KEYCLOAK_REALM: ticketing
  #     KEYCLOAK_CLIENT_ID: myclient
  #     KEYCLOAK_ADMIN_USER: AdminUser
  #     KEYCLOAK_ADMIN_PASSWORD: admin123
  #     COOKIE_SECURE: "false"
  #     CORS_ALLOWED_ORIGINS: "*"
  #   depends_on:
  #     - ticketing-postgres-shadow
  #     - keycloak
  #   networks:
  #     - prod-network
  #   labels:
  #     - "traefik.http.services.ticketing-shadow.loadbalancer.server.port=8080"
  #   restart: unless-stopped
  #
  # ticketing-postgres-shadow:
  #   image: postgres:17-alpine
  #   environment:
  #     POSTGRES_USER: ticketing
  #     POSTGRES_PASSWORD: ticketing
  #     POSTGRES_DB: ticketing
  #   volumes:
  #     - ticketing-shadow-data:/var/lib/postgresql/data
  #   networks:
  #     - prod-network
  #   restart: unless-stopped

networks:
  prod-network:
    driver: bridge

volumes:
  shadowing-prod-data:
  keycloak-prod-data:
  ticketing-prod-data:
  n8n-prod-postgres-data:
  # Uncomment for shadow deployments
  # ticketing-shadow-data:
