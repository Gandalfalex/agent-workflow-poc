import { computed, ref } from "vue";

type Locale = "en" | "de";
type TranslationTable = Record<string, string>;

const STORAGE_KEY = "app.locale";

const messages: Record<Locale, TranslationTable> = {
    en: {
        "common.clear": "Clear",
        "common.loading": "Loading...",
        "common.close": "Close",
        "common.cancel": "Cancel",
        "common.delete": "Delete",
        "common.save": "Save",
        "common.add": "Add",
        "board.search.placeholder": "Filter tickets...",
        "board.toolbar.views": "Views",
        "board.toolbar.filters": "Filters",
        "board.toolbar.hideFilters": "Hide filters",
        "board.toolbar.shortcuts": "Shortcuts",
        "board.shortcuts.search": "Focus search",
        "board.shortcuts.newTicket": "Open new ticket",
        "board.filter.allStates": "All states",
        "board.filter.allAssignees": "All assignees",
        "board.filter.allPriorities": "All priorities",
        "board.filter.allTypes": "All types",
        "board.filter.blockedOnly": "Blocked only",
        "board.filter.selectPreset": "Select preset...",
        "board.filter.presetName": "Preset name",
        "board.filter.loadingPresets": "Loading presets...",
        "board.preset.save": "Save",
        "board.preset.rename": "Rename",
        "board.preset.delete": "Delete",
        "board.preset.share": "Share",
        "board.preset.saveView": "Save view",
        "board.preset.cancel": "Cancel",
        "board.bulk.moveState": "Move state",
        "board.bulk.assignUser": "Assign user",
        "board.bulk.setPriority": "Set priority",
        "board.bulk.deleteTickets": "Delete tickets",
        "board.bulk.selectState": "Select state...",
        "board.bulk.selectAssignee": "Select assignee...",
        "board.bulk.deleteHint": "Deletes selected tickets.",
        "board.bulk.apply": "Apply bulk action",
        "board.bulk.applying": "Applying...",
        "board.view.loading": "Loading board...",
        "board.view.setup": "Setup",
        "board.view.createWorkflow": "Create your first workflow",
        "board.view.emptyWorkflow":
            "The board is empty because no workflow states exist yet. Initialize a default board to start adding tickets.",
        "board.view.creating": "Creating...",
        "board.view.initialize": "Initialize board",
        "board.view.storySection": "Board stories",
        "board.view.storyHelp":
            "Stories group tickets horizontally across workflow states.",
        "board.view.storiesCount": "{count} stories",
        "board.view.ticketsCount": "{count} tickets",
        "board.view.exitSelect": "Exit select",
        "board.view.selectTickets": "Select tickets",
        "board.view.selectedCount": "{count} selected",
        "board.view.addStory": "Add story",
        "board.view.noMatchingTitle": "No matching tickets",
        "board.view.noMatchingBody": "Nothing matched",
        "board.view.clearFilter": "Clear filter",
        "board.view.story": "Story",
        "board.view.storyGroup": "Story Group",
        "board.view.deleteStory": "Delete story",
        "board.view.storyActions": "Story actions",
        "board.view.storyLabel": "Story",
        "board.view.ticketCount": "{count} tickets",
        "board.view.addTicket": "+ Add ticket",
        "board.view.blocked": "Blocked ({count})",
        "board.view.unassigned": "Unassigned",
        "board.view.dragCard": "Drag card",
        "board.view.dropHere": "Drop here",
        "board.view.openTicket": "Open ticket",
        "header.board": "Board",
        "header.dashboard": "Dashboard",
        "header.settings": "Settings",
        "header.brand": "Ops Console",
        "header.workspaceDefault": "Ticketing Workspace",
        "header.selectProject": "Select project",
        "header.inbox": "Inbox",
        "header.notifications": "Notifications",
        "header.markAllRead": "Mark all read",
        "header.close": "Close",
        "header.mentions": "Mentions",
        "header.assignments": "Assignments",
        "header.noNotifications": "No notifications.",
        "header.markRead": "Mark read",
        "header.logout": "Logout",
        "header.liveWs": "Live updates via WebSocket",
        "header.livePolling": "Fallback updates via polling",
        "newTicket.title": "New ticket",
        "newTicket.subtitle": "Create a card",
        "newTicket.aiTriage": "AI Triage",
        "newTicket.suggest": "Suggest",
        "newTicket.suggesting": "Suggesting...",
        "newTicket.aiDisabled": "AI triage is disabled for this project.",
        "newTicket.applySummary": "Apply summary",
        "newTicket.applyPriority": "Apply priority",
        "newTicket.applyState": "Apply state",
        "newTicket.applyAssignee": "Apply assignee",
        "newTicket.fieldTitle": "Title",
        "newTicket.fieldDescription": "Description",
        "newTicket.fieldType": "Type",
        "newTicket.fieldPriority": "Priority",
        "newTicket.fieldStory": "Story",
        "newTicket.fieldState": "State",
        "newTicket.fieldAssignee": "Assignee",
        "newTicket.shortSummaryPlaceholder": "Short summary",
        "newTicket.descriptionPlaceholder": "What needs to happen?",
        "newTicket.selectStory": "Select a story",
        "newTicket.assigneeSearchPlaceholder": "Search from group members...",
        "newTicket.noUsersFound": "No users found matching \"{query}\"",
        "newTicket.noGroupMembers": "No group members available",
        "newTicket.create": "Create ticket",
        "ticket.titleLabel": "Ticket",
        "ticket.actionsLabel": "Ticket actions",
        "ticket.fieldTitle": "Title",
        "ticket.fieldDescription": "Description",
        "ticket.describePlaceholder": "Describe the ticket...",
        "ticket.fieldType": "Type",
        "ticket.fieldPriority": "Priority",
        "ticket.fieldState": "State",
        "ticket.deleteTicket": "Delete ticket",
        "ticket.incidentMode": "Incident mode",
        "ticket.severity": "Severity",
        "ticket.commander": "Commander",
        "ticket.impact": "Impact",
        "ticket.select": "Select",
        "ticket.unassigned": "Unassigned",
        "ticket.attachments": "Attachments",
        "ticket.upload": "+ Upload",
        "ticket.uploading": "Uploading...",
        "ticket.noFiles": "No files attached.",
        "ticket.dependencies": "Dependencies",
        "ticket.loading": "Loading...",
        "ticket.selectTicket": "Select ticket",
        "ticket.remove": "Remove",
        "ticket.noDependencies": "No dependencies.",
        "ticket.graphTitle": "Graph (2-hop)",
        "ticket.loadingGraph": "Loading graph...",
        "ticket.graphNodesEdges": "{nodes} nodes · {edges} edges",
        "ticket.openGraph": "Open graph",
        "ticket.activity": "Activity",
        "ticket.incidentTimeline": "Incident timeline",
        "ticket.eventsCount": "{count} events",
        "ticket.expand": "Expand",
        "ticket.collapse": "Collapse",
        "ticket.exportPostmortem": "Export postmortem",
        "ticket.loadingTimeline": "Loading timeline...",
        "ticket.noTimeline": "No incident timeline events yet.",
        "ticket.comments": "Comments",
        "ticket.saving": "Saving...",
        "ticket.noComments": "No comments yet.",
        "ticket.addComment": "Add comment (Markdown)",
        "ticket.commentPlaceholder": "Progress, blockers, notes...",
        "ticket.post": "Post",
        "ticket.posting": "Posting...",
        "ticket.saveChanges": "Save changes",
        "ticket.dependencyGraph": "Dependency graph",
        "ticket.dependencyGraphView": "{key} · 2-hop view",
        "ticket.dependencyGraphAria": "Ticket dependency graph",
        "ticket.noDependencyGraph": "No dependency graph data yet.",
        "ticket.relationBlocks": "blocks",
        "ticket.relationBlockedBy": "blocked_by",
        "ticket.relationRelated": "related",
        "ticket.activityChangedState": "changed state from {old} to {new}",
        "ticket.activityChangedPriority":
            "changed priority from {old} to {new}",
        "ticket.activityAssignedTo": "assigned to {new}",
        "ticket.activityRemovedAssignee": "removed assignee",
        "ticket.activityChangedType": "changed type from {old} to {new}",
        "ticket.activityRenamed": "renamed ticket",
        "ticket.activityChangedIncidentSeverity":
            "changed incident severity from {old} to {new}",
        "ticket.unknownValue": "-",
    },
    de: {
        "common.clear": "Leeren",
        "common.loading": "Lädt...",
        "common.close": "Schließen",
        "common.cancel": "Abbrechen",
        "common.delete": "Löschen",
        "common.save": "Speichern",
        "common.add": "Hinzufügen",
        "board.search.placeholder": "Tickets filtern...",
        "board.toolbar.views": "Ansichten",
        "board.toolbar.filters": "Filter",
        "board.toolbar.hideFilters": "Filter ausblenden",
        "board.toolbar.shortcuts": "Shortcuts",
        "board.shortcuts.search": "Suche fokussieren",
        "board.shortcuts.newTicket": "Neues Ticket öffnen",
        "board.filter.allStates": "Alle Status",
        "board.filter.allAssignees": "Alle Zuständigen",
        "board.filter.allPriorities": "Alle Prioritäten",
        "board.filter.allTypes": "Alle Typen",
        "board.filter.blockedOnly": "Nur blockierte",
        "board.filter.selectPreset": "Preset wählen...",
        "board.filter.presetName": "Preset-Name",
        "board.filter.loadingPresets": "Presets laden...",
        "board.preset.save": "Speichern",
        "board.preset.rename": "Umbenennen",
        "board.preset.delete": "Löschen",
        "board.preset.share": "Teilen",
        "board.preset.saveView": "Ansicht speichern",
        "board.preset.cancel": "Abbrechen",
        "board.bulk.moveState": "Status ändern",
        "board.bulk.assignUser": "Zuweisen",
        "board.bulk.setPriority": "Priorität setzen",
        "board.bulk.deleteTickets": "Tickets löschen",
        "board.bulk.selectState": "Status wählen...",
        "board.bulk.selectAssignee": "Zuständige wählen...",
        "board.bulk.deleteHint": "Löscht ausgewählte Tickets.",
        "board.bulk.apply": "Sammelaktion anwenden",
        "board.bulk.applying": "Wird angewendet...",
        "board.view.loading": "Board wird geladen...",
        "board.view.setup": "Einrichtung",
        "board.view.createWorkflow": "Ersten Workflow erstellen",
        "board.view.emptyWorkflow":
            "Das Board ist leer, weil noch keine Workflow-Status existieren. Initialisiere ein Standard-Board, um Tickets anzulegen.",
        "board.view.creating": "Wird erstellt...",
        "board.view.initialize": "Board initialisieren",
        "board.view.storySection": "Board Stories",
        "board.view.storyHelp":
            "Stories gruppieren Tickets horizontal über Workflow-Status.",
        "board.view.storiesCount": "{count} Stories",
        "board.view.ticketsCount": "{count} Tickets",
        "board.view.exitSelect": "Auswahl beenden",
        "board.view.selectTickets": "Tickets auswählen",
        "board.view.selectedCount": "{count} ausgewählt",
        "board.view.addStory": "Story hinzufügen",
        "board.view.noMatchingTitle": "Keine passenden Tickets",
        "board.view.noMatchingBody": "Nichts gefunden für",
        "board.view.clearFilter": "Filter leeren",
        "board.view.story": "Story",
        "board.view.storyGroup": "Story-Gruppe",
        "board.view.deleteStory": "Story löschen",
        "board.view.storyActions": "Story-Aktionen",
        "board.view.storyLabel": "Story",
        "board.view.ticketCount": "{count} Tickets",
        "board.view.addTicket": "+ Ticket hinzufügen",
        "board.view.blocked": "Blockiert ({count})",
        "board.view.unassigned": "Nicht zugewiesen",
        "board.view.dragCard": "Karte ziehen",
        "board.view.dropHere": "Hier ablegen",
        "board.view.openTicket": "Ticket öffnen",
        "header.board": "Board",
        "header.dashboard": "Dashboard",
        "header.settings": "Einstellungen",
        "header.brand": "Ops-Konsole",
        "header.workspaceDefault": "Ticketing-Arbeitsbereich",
        "header.selectProject": "Projekt wählen",
        "header.inbox": "Inbox",
        "header.notifications": "Benachrichtigungen",
        "header.markAllRead": "Alle gelesen",
        "header.close": "Schließen",
        "header.mentions": "Erwähnungen",
        "header.assignments": "Zuweisungen",
        "header.noNotifications": "Keine Benachrichtigungen.",
        "header.markRead": "Als gelesen",
        "header.logout": "Abmelden",
        "header.liveWs": "Live-Updates per WebSocket",
        "header.livePolling": "Fallback-Updates per Polling",
        "newTicket.title": "Neues Ticket",
        "newTicket.subtitle": "Karte erstellen",
        "newTicket.aiTriage": "AI-Triage",
        "newTicket.suggest": "Vorschlagen",
        "newTicket.suggesting": "Wird vorgeschlagen...",
        "newTicket.aiDisabled": "AI-Triage ist für dieses Projekt deaktiviert.",
        "newTicket.applySummary": "Zusammenfassung anwenden",
        "newTicket.applyPriority": "Priorität anwenden",
        "newTicket.applyState": "Status anwenden",
        "newTicket.applyAssignee": "Zuständige anwenden",
        "newTicket.fieldTitle": "Titel",
        "newTicket.fieldDescription": "Beschreibung",
        "newTicket.fieldType": "Typ",
        "newTicket.fieldPriority": "Priorität",
        "newTicket.fieldStory": "Story",
        "newTicket.fieldState": "Status",
        "newTicket.fieldAssignee": "Zuständige",
        "newTicket.shortSummaryPlaceholder": "Kurze Zusammenfassung",
        "newTicket.descriptionPlaceholder": "Was muss passieren?",
        "newTicket.selectStory": "Story auswählen",
        "newTicket.assigneeSearchPlaceholder": "In Gruppenmitgliedern suchen...",
        "newTicket.noUsersFound": "Keine Nutzer gefunden für \"{query}\"",
        "newTicket.noGroupMembers": "Keine Gruppenmitglieder verfügbar",
        "newTicket.create": "Ticket erstellen",
        "ticket.titleLabel": "Ticket",
        "ticket.actionsLabel": "Ticket-Aktionen",
        "ticket.fieldTitle": "Titel",
        "ticket.fieldDescription": "Beschreibung",
        "ticket.describePlaceholder": "Ticket beschreiben...",
        "ticket.fieldType": "Typ",
        "ticket.fieldPriority": "Priorität",
        "ticket.fieldState": "Status",
        "ticket.deleteTicket": "Ticket löschen",
        "ticket.incidentMode": "Incident-Modus",
        "ticket.severity": "Schweregrad",
        "ticket.commander": "Incident Commander",
        "ticket.impact": "Auswirkung",
        "ticket.select": "Auswählen",
        "ticket.unassigned": "Nicht zugewiesen",
        "ticket.attachments": "Anhänge",
        "ticket.upload": "+ Hochladen",
        "ticket.uploading": "Wird hochgeladen...",
        "ticket.noFiles": "Keine Dateien angehängt.",
        "ticket.dependencies": "Abhängigkeiten",
        "ticket.loading": "Lädt...",
        "ticket.selectTicket": "Ticket auswählen",
        "ticket.remove": "Entfernen",
        "ticket.noDependencies": "Keine Abhängigkeiten.",
        "ticket.graphTitle": "Graph (2-Hop)",
        "ticket.loadingGraph": "Graph wird geladen...",
        "ticket.graphNodesEdges": "{nodes} Knoten · {edges} Kanten",
        "ticket.openGraph": "Graph öffnen",
        "ticket.activity": "Aktivität",
        "ticket.incidentTimeline": "Incident-Zeitachse",
        "ticket.eventsCount": "{count} Ereignisse",
        "ticket.expand": "Erweitern",
        "ticket.collapse": "Einklappen",
        "ticket.exportPostmortem": "Postmortem exportieren",
        "ticket.loadingTimeline": "Zeitachse wird geladen...",
        "ticket.noTimeline": "Noch keine Incident-Ereignisse.",
        "ticket.comments": "Kommentare",
        "ticket.saving": "Wird gespeichert...",
        "ticket.noComments": "Noch keine Kommentare.",
        "ticket.addComment": "Kommentar hinzufügen (Markdown)",
        "ticket.commentPlaceholder": "Fortschritt, Blocker, Notizen...",
        "ticket.post": "Posten",
        "ticket.posting": "Wird gepostet...",
        "ticket.saveChanges": "Änderungen speichern",
        "ticket.dependencyGraph": "Abhängigkeitsgraph",
        "ticket.dependencyGraphView": "{key} · 2-Hop-Ansicht",
        "ticket.dependencyGraphAria": "Ticket-Abhängigkeitsgraph",
        "ticket.noDependencyGraph": "Noch keine Graph-Daten.",
        "ticket.relationBlocks": "blockiert",
        "ticket.relationBlockedBy": "blockiert durch",
        "ticket.relationRelated": "verwandt",
        "ticket.activityChangedState": "Status geändert von {old} zu {new}",
        "ticket.activityChangedPriority":
            "Priorität geändert von {old} zu {new}",
        "ticket.activityAssignedTo": "zugewiesen an {new}",
        "ticket.activityRemovedAssignee": "Zuweisung entfernt",
        "ticket.activityChangedType": "Typ geändert von {old} zu {new}",
        "ticket.activityRenamed": "Ticket umbenannt",
        "ticket.activityChangedIncidentSeverity":
            "Incident-Schweregrad geändert von {old} zu {new}",
        "ticket.unknownValue": "-",
    },
};

const detectLocale = (): Locale => {
    if (typeof window === "undefined") return "en";
    const saved = window.localStorage.getItem(STORAGE_KEY);
    if (saved === "en" || saved === "de") return saved;
    const browser = window.navigator.language.toLowerCase();
    return browser.startsWith("de") ? "de" : "en";
};

const activeLocale = ref<Locale>(detectLocale());

if (typeof document !== "undefined") {
    document.documentElement.lang = activeLocale.value;
}

const interpolate = (
    text: string,
    params?: Record<string, string | number>,
): string => {
    if (!params) return text;
    return Object.entries(params).reduce(
        (result, [key, value]) =>
            result.split(`{${key}}`).join(String(value)),
        text,
    );
};

export const useI18n = () => {
    const setLocale = (locale: Locale) => {
        activeLocale.value = locale;
        if (typeof document !== "undefined") {
            document.documentElement.lang = locale;
        }
        if (typeof window !== "undefined") {
            window.localStorage.setItem(STORAGE_KEY, locale);
        }
    };

    const t = (key: string, params?: Record<string, string | number>) => {
        const dict = messages[activeLocale.value] || messages.en;
        const template = dict[key] || messages.en[key] || key;
        return interpolate(template, params);
    };

    return {
        availableLocales: ["en", "de"] as const,
        locale: computed(() => activeLocale.value),
        setLocale,
        t,
    };
};
