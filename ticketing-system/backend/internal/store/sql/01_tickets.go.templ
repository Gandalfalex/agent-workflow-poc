{{define "ticket_select_fields"}}
t.id, t.project_id, p.key, t.key, t.number, t.type, t.story_id, s2.title, s2.description, s2.story_points, s2.created_at, s2.updated_at,
t.title, t.description, t.state_id, t.assignee_id,
t.priority, t.incident_enabled, t.incident_severity, t.incident_impact, t.incident_commander_id, t.position,
t.story_points, t.time_estimate,
COALESCE((SELECT SUM(te.minutes) FROM time_entries te WHERE te.ticket_id = t.id), 0)::int AS time_logged,
t.created_at, t.updated_at,
s.name, s.sort_order, s.is_default, s.is_closed,
COALESCE(blockers.blocked_by_count, 0) AS blocked_by_count,
(COALESCE(blockers.blocked_by_count, 0) > 0) AS is_blocked,
u.name,
cu.name
{{end}}

{{define "ticket_select_joins"}}
FROM tickets t
JOIN projects p ON p.id = t.project_id
JOIN workflow_states s ON s.id = t.state_id
JOIN stories s2 ON s2.id = t.story_id
LEFT JOIN users u ON u.id = t.assignee_id
LEFT JOIN users cu ON cu.id = t.incident_commander_id
LEFT JOIN (
  SELECT td.to_ticket_id AS ticket_id, COUNT(*)::int AS blocked_by_count
  FROM ticket_dependencies td
  WHERE td.relation_type = 'blocks'
  GROUP BY td.to_ticket_id
) blockers ON blockers.ticket_id = t.id
{{end}}

{{define "tickets_board.sql"}}
SELECT {{template "ticket_select_fields" .}}
{{template "ticket_select_joins" .}}
WHERE t.project_id = $1
ORDER BY s.sort_order ASC, t.position ASC
{{end}}

{{define "tickets_count.sql"}}
SELECT COUNT(*)
FROM tickets t
{{- if .Where }}
WHERE {{ .Where }}
{{- end }}
{{end}}

{{define "tickets_current_state.sql"}}
SELECT state_id FROM tickets WHERE id = $1
{{end}}

{{define "tickets_delete.sql"}}
DELETE FROM tickets WHERE id = $1
{{end}}

{{define "tickets_get.sql"}}
SELECT {{template "ticket_select_fields" .}}
{{template "ticket_select_joins" .}}
WHERE t.id = $1
{{end}}

{{define "tickets_insert.sql"}}
INSERT INTO tickets (
  project_id, title, description, type, story_id, state_id, assignee_id, priority,
  incident_enabled, incident_severity, incident_impact, incident_commander_id, position,
  story_points, time_estimate
)
VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15)
RETURNING id
{{end}}

{{define "tickets_list.sql"}}
SELECT {{template "ticket_select_fields" .}}
{{template "ticket_select_joins" .}}
{{- if .Where }}
WHERE {{ .Where }}
{{- end }}
ORDER BY s.sort_order ASC, t.position ASC
LIMIT ${{ .LimitArg }} OFFSET ${{ .OffsetArg }}
{{end}}

{{define "tickets_next_position.sql"}}
SELECT COALESCE(MAX(position), 0) + 1
FROM tickets
WHERE state_id = $1
{{end}}

{{define "tickets_state_any.sql"}}
SELECT id
FROM workflow_states
WHERE project_id = $1
ORDER BY sort_order ASC
LIMIT 1
{{end}}

{{define "tickets_state_default.sql"}}
SELECT id
FROM workflow_states
WHERE project_id = $1 AND is_default = true
ORDER BY sort_order ASC
LIMIT 1
{{end}}

{{define "tickets_update.sql"}}
UPDATE tickets
SET {{ .Updates }}
WHERE id = ${{ .IDArg }}
{{end}}
