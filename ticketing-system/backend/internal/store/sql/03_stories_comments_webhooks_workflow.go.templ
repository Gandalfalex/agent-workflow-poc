{{define "story_fields"}}
id, project_id, title, description, story_points, created_at, updated_at
{{end}}

{{define "webhook_fields"}}
id, url, events, enabled, secret, created_at, updated_at
{{end}}

{{define "stories_delete.sql"}}
WITH target AS (
  SELECT id
  FROM stories
  WHERE id = $1
),
deleted_tickets AS (
  DELETE FROM tickets
  WHERE story_id IN (SELECT id FROM target)
)
DELETE FROM stories
WHERE id IN (SELECT id FROM target)
{{end}}

{{define "stories_get.sql"}}
SELECT {{template "story_fields" .}}
FROM stories
WHERE id = $1
{{end}}

{{define "stories_insert.sql"}}
INSERT INTO stories (project_id, title, description, story_points)
VALUES ($1, $2, $3, $4)
RETURNING id
{{end}}

{{define "stories_list.sql"}}
SELECT {{template "story_fields" .}}
FROM stories
WHERE project_id = $1
ORDER BY created_at DESC
{{end}}

{{define "stories_update.sql"}}
UPDATE stories
SET title = COALESCE($2, title),
    description = COALESCE($3, description),
    story_points = COALESCE($4, story_points),
    updated_at = now()
WHERE id = $1
RETURNING id
{{end}}

{{define "comments_delete.sql"}}
DELETE FROM ticket_comments
WHERE id = $1
{{end}}

{{define "comments_insert.sql"}}
INSERT INTO ticket_comments (ticket_id, author_id, author_name, message)
VALUES ($1, $2, $3, $4)
RETURNING id
{{end}}

{{define "comments_list.sql"}}
SELECT id, ticket_id, author_id, author_name, message, created_at
FROM ticket_comments
WHERE ticket_id = $1
ORDER BY created_at ASC
{{end}}

{{define "webhooks_delete.sql"}}
DELETE FROM webhooks WHERE project_id = $1 AND id = $2
{{end}}

{{define "webhooks_get.sql"}}
SELECT {{template "webhook_fields" .}}
FROM webhooks
WHERE project_id = $1 AND id = $2
{{end}}

{{define "webhooks_insert.sql"}}
INSERT INTO webhooks (project_id, url, events, enabled, secret)
VALUES ($1, $2, $3, $4, $5)
RETURNING id
{{end}}

{{define "webhooks_list.sql"}}
SELECT {{template "webhook_fields" .}}
FROM webhooks
WHERE project_id = $1
ORDER BY created_at DESC
{{end}}

{{define "webhooks_list_by_event.sql"}}
SELECT {{template "webhook_fields" .}}
FROM webhooks
WHERE project_id = $1 AND enabled = true AND events ? $2
ORDER BY created_at DESC
{{end}}

{{define "webhooks_update.sql"}}
UPDATE webhooks
SET {{ .Updates }}
WHERE project_id = ${{ .ProjectArg }} AND id = ${{ .IDArg }}
{{end}}

{{define "workflow_delete.sql"}}
DELETE FROM workflow_states WHERE project_id = $1
{{end}}

{{define "workflow_insert.sql"}}
INSERT INTO workflow_states (id, project_id, name, sort_order, is_default, is_closed, created_at, updated_at)
VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
{{end}}

{{define "workflow_list.sql"}}
SELECT id, name, sort_order, is_default, is_closed, created_at, updated_at
FROM workflow_states
WHERE project_id = $1
ORDER BY sort_order ASC
{{end}}
